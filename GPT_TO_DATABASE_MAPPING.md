# GPT Output to Database Column Mapping

This document shows exactly what GPT-4o outputs after each session and which columns in the `live_sessions` table are updated.

## Core Scores (Direct Columns)

| GPT Output Field | Database Column | Type | Notes |
|-----------------|----------------|------|-------|
| `finalScores.overall` | `overall_score` | INTEGER (0-100) | Overall performance score |
| `finalScores.rapport` | `rapport_score` | INTEGER (0-100) | Connection and trust building quality |
| `finalScores.discovery` | `discovery_score` | INTEGER (0-100) | Quality of questions asked and listening |
| `finalScores.objectionHandling` | `objection_handling_score` | INTEGER (0-100) | How well objections were addressed |
| `finalScores.closing` | `close_score` | INTEGER (0-100) | Closing technique score (90-100 if sale closed) |
| `finalScores` (entire object) | `final_scores` | JSONB | Complete scores object (stored in analytics too) |

## Sale/Deal Status (Direct Columns)

| GPT Output Field | Database Column | Type | Notes |
|-----------------|----------------|------|-------|
| `sale_closed` | `sale_closed` | BOOLEAN | Whether the sale closed successfully |
| `return_appointment` | `return_appointment` | BOOLEAN | Whether a return appointment was scheduled |
| `virtual_earnings` | `virtual_earnings` | DECIMAL(10,2) | Total virtual earnings (same as total_contract_value if sale closed) |
| `total_contract_value` | `total_contract_value` | DECIMAL(10,2) | Total value of the sale (also in deal_details) |

## Earnings & Deal Data (JSONB Columns)

| GPT Output Field | Database Column | Type | Notes |
|-----------------|----------------|------|-------|
| `earnings_data` | `earnings_data` | JSONB | Detailed earnings breakdown: `{base_amount, closed_amount, total_earned}` |
| `deal_details` | `deal_details` | JSONB | Product/contract details: `{product_sold, service_type, base_price, monthly_value, contract_length, total_contract_value, payment_method, add_ons, start_date}` |

## Feedback & Assessment (Direct Columns - Being Removed)

**Note:** These columns are being removed in migration 122 as they're duplicated in `analytics` JSONB:

| GPT Output Field | Database Column | Type | Status |
|-----------------|----------------|------|--------|
| `overallAssessment` | `overall_assessment` | TEXT | ⚠️ **REMOVED** - Use `analytics.deep_analysis.overallAssessment` |
| `topStrengths` | `top_strengths` | TEXT[] | ⚠️ **REMOVED** - Use `analytics.feedback.strengths` |
| `topImprovements` | `top_improvements` | TEXT[] | ⚠️ **REMOVED** - Use `analytics.feedback.improvements` |
| `session_highlight` | `session_highlight` | TEXT | ⚠️ **REMOVED** - Use `analytics.session_highlight` |

## Coaching & Feedback (JSONB Columns - Being Removed)

**Note:** These columns are being removed in migration 122 as they're duplicated in `analytics` JSONB:

| GPT Output Field | Database Column | Type | Status |
|-----------------|----------------|------|--------|
| `coachingPlan` | `coaching_plan` | JSONB | ⚠️ **REMOVED** - Use `analytics.coaching_plan` |
| `feedback` | `feedback_data` | JSONB | ⚠️ **REMOVED** - Use `analytics.feedback` |
| `finalScores` | `final_scores` | JSONB | ⚠️ **REMOVED** - Use `analytics.deep_analysis.finalScores` |

## Grading Metadata (Direct Columns)

| GPT Output Field | Database Column | Type | Notes |
|-----------------|----------------|------|-------|
| N/A (set by system) | `grading_status` | TEXT | Set to `'complete'` after grading |
| N/A (set by system) | `grading_version` | TEXT | Currently `'2.0'` |
| N/A (set by system) | `graded_at` | TIMESTAMPTZ | Timestamp when grading completed |
| N/A (generated by system) | `grading_audit` | JSONB | ⚠️ **REMOVED** - Use `analytics.grading_audit` |

## Analytics JSONB Structure

All GPT outputs are also stored in the `analytics` JSONB column for easy access:

```json
{
  "deep_analysis": {
    "saleClosed": boolean,              // → sale_closed column
    "virtualEarnings": number,          // → virtual_earnings column
    "returnAppointment": boolean,      // → return_appointment column
    "finalScores": {                    // → individual score columns
      "overall": number,                // → overall_score
      "rapport": number,                // → rapport_score
      "discovery": number,              // → discovery_score
      "objectionHandling": number,      // → objection_handling_score
      "closing": number                 // → close_score
    },
    "overallAssessment": string,        // → overall_assessment (removed)
    "topStrengths": string[],           // → top_strengths (removed)
    "topImprovements": string[],        // → top_improvements (removed)
    "sessionHighlight": string,          // → session_highlight (removed)
    "dealDetails": {...},               // → deal_details column
    "earningsData": {...}               // → earnings_data column
  },
  "coaching_plan": {...},               // → coaching_plan (removed)
  "feedback": {                         // → feedback_data (removed)
    "strengths": string[],
    "improvements": string[],
    "specific_tips": string[]
  },
  "session_highlight": string,          // → session_highlight (removed)
  "final_scores": {...},                // → final_scores (removed)
  "earnings_data": {...},               // → earnings_data column
  "deal_details": {...},                // → deal_details column
  "grading_audit": {...},               // → grading_audit (removed)
  "grading_version": "2.0",
  "graded_at": "ISO timestamp"
}
```

## Complete Update Flow

When GPT-4o completes analysis, the following update is made to `live_sessions`:

```typescript
updateData = {
  // Core scores (from finalScores)
  overall_score: finalScores.overall,
  rapport_score: Math.round(finalScores.rapport),
  discovery_score: Math.round(finalScores.discovery),
  objection_handling_score: Math.round(finalScores.objectionHandling),
  close_score: Math.round(finalScores.closing),
  
  // Sale/Deal status
  sale_closed: saleClosed,
  return_appointment: returnAppointment,
  virtual_earnings: virtualEarnings,
  total_contract_value: dealDetails?.total_contract_value,
  
  // JSONB columns
  earnings_data: earningsData,
  deal_details: dealDetails,
  
  // Grading metadata
  grading_status: 'complete',
  grading_version: '2.0',
  graded_at: new Date().toISOString(),
  
  // Analytics JSONB (contains everything)
  analytics: {
    deep_analysis: {
      saleClosed,
      virtualEarnings,
      returnAppointment,
      finalScores,
      overallAssessment,
      topStrengths,
      topImprovements,
      sessionHighlight,
      dealDetails,
      earningsData,
      feedback
    },
    coaching_plan: coachingPlan,
    feedback: feedback,
    session_highlight: sessionHighlight,
    final_scores: finalScores,
    earnings_data: earningsData,
    deal_details: dealDetails,
    grading_audit: gradingAudit,
    grading_version: '2.0',
    graded_at: timestamp
  }
}
```

## Important Notes

1. **Dual Storage**: Most GPT outputs are stored in BOTH:
   - Direct columns (for easy querying/sorting)
   - `analytics` JSONB (for complete data access)

2. **Column Removal**: Migration 122 removes redundant columns that duplicate `analytics` JSONB data:
   - `top_strengths`, `top_improvements`, `overall_assessment`, `session_highlight`
   - `feedback_data`, `final_scores`, `coaching_plan`, `grading_audit`
   - `total_contract_value` (use `deal_details.total_contract_value` instead)

3. **Score Enforcement**: After GPT analysis, scores may be adjusted:
   - If `sale_closed=true`: Minimum `overall_score` of 80 (85+ if objections handled well)
   - If `sale_closed=true`: Minimum `close_score` of 90

4. **Fallback Detection**: If GPT doesn't detect a sale, fallback patterns check the transcript and may override `sale_closed`.

5. **Earnings Trigger**: When `virtual_earnings > 0` AND `ended_at IS NOT NULL`, a database trigger automatically updates the user's total `virtual_earnings` in the `users` table.

## Recommended Access Pattern

**For Frontend/API Access:**
- Use direct columns for scores: `overall_score`, `rapport_score`, etc.
- Use `analytics` JSONB for detailed feedback, coaching plans, and audit trails
- Use `deal_details` and `earnings_data` JSONB columns for deal information

**Example:**
```typescript
// Direct columns (fast queries)
const overallScore = session.overall_score
const saleClosed = session.sale_closed

// Analytics JSONB (detailed data)
const strengths = session.analytics?.feedback?.strengths
const coachingPlan = session.analytics?.coaching_plan
const auditTrail = session.analytics?.grading_audit
```


